---
title: "CompMus"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    self_contained: true
    keep_md: true
    standalone: true
---

```{r setup, include=FALSE}
library(flexdashboard)
library(corrplot)
library(tidyverse)
library(ggplot2)
source("compmus.R")
library(tidymodels)
library(ggdendro)
library(heatmaply)
library(plotly)
library(shiny)
library(ggthemes)


get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit |> 
    collect_predictions() |> 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit |> 
    conf_mat_resampled() |> 
    group_by(Prediction) |> mutate(precision = Freq / sum(Freq)) |> 
    group_by(Truth) |> mutate(recall = Freq / sum(Freq)) |> 
    ungroup() |> filter(Prediction == Truth) |> 
    select(class = Prediction, precision, recall)
}  

compmus2025 <- read_csv("compmus2025.csv")

cluster_juice <-
  recipe(
    filename ~
      arousal +
      danceability +
      instrumentalness +
      tempo +
      valence,
    data = compmus2025
  ) |>
  step_center(all_predictors()) |>
  step_scale(all_predictors()) |> 
  # step_range(all_predictors()) |> 
  prep(compmus2025) |>
  juice() |>
  column_to_rownames("filename")

compmus_dist <- dist(cluster_juice, method = "euclidean")

```
Hierarchical Clustering 
=====================================
Row {data-height=400}
-----------------------------------------------------------------------
### Single linkage 
```{r, echo=FALSE}
compmus_dist |> 
  hclust(method = "single") |>  
  dendro_data() |>
  ggdendrogram()
```
-----------------------------------------------------------------------
### Average linkage 
```{r, echo=FALSE}
compmus_dist |> 
  hclust(method = "average") |> # Try single, average, and complete.
  dendro_data() |>
  ggdendrogram()
```

Row {data-height=400}
-----------------------------------------------------------------------
### Complete linkage
```{r, echo=FALSE}
compmus_dist |> 
  hclust(method = "complete") |> # Try single, average, and complete.
  dendro_data() |>
  ggdendrogram()
```
-----------------------------------------------------------------------
### Heatmap of feature values 
```{r, echo=FALSE}
heatmaply(
  cluster_juice,
  hclustfun = hclust,
  hclust_method = "complete",  # Change for single, average, or complete linkage.
  dist_method = "euclidean"
)
```

Row {.sidebar data-height=1000}
-------------------------------------
### Analysis 
We can see that clustering with the method single, gives us the worst result, the cluster splits are very small and not vertically balanced. The average method gives us better results, we can already see clusters more higher up in the tree, but on the left we can see a cluster, whcih is not taking into regard in the higher clusters. In the complete clustering we see reasonable balanced clusters, and we see that the first 2 clusters at the top include all the songs. 

*** in the heatmap
